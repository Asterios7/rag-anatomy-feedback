name: Deploy Streamlit to Azure

on:
  workflow_dispatch:
    inputs:
      RESOURCE_GROUP:
        description: "Resource Group Name"
        required: true
        default: "testrg"
      LOCATION:
        description: "Azure Region"
        required: true
        default: "westeurope"
      APP_NAME:
        description: "Container App Name"
        required: true
        default: "streamlit-app"
      IMAGE_NAME:
        description: "Docker Image Name (without registry)"
        required: true
        default: "streamlit-app"
      IMAGE_TAG:
        description: "Docker Image Tag"
        required: true
        default: "latest"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set variables from inputs
        run: |
          echo "RESOURCE_GROUP=${{ github.event.inputs.RESOURCE_GROUP }}" >> $GITHUB_ENV
          echo "LOCATION=${{ github.event.inputs.LOCATION }}" >> $GITHUB_ENV
          echo "APP_NAME=${{ github.event.inputs.APP_NAME }}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${{ github.event.inputs.IMAGE_NAME }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.event.inputs.IMAGE_TAG }}" >> $GITHUB_ENV
          echo "ENV_NAME=${{ github.event.inputs.APP_NAME }}-env" >> $GITHUB_ENV
          echo "ACR_NAME=${{ github.event.inputs.RESOURCE_GROUP }}acr" >> $GITHUB_ENV

      - name: Create or update Resource Group
        run: |
          az group create --name $RESOURCE_GROUP --location $LOCATION

      - name: Create or update Azure Container Registry
        run: |
          EXISTING_ACR=$(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "name" -o tsv || echo "")
          if [ -z "$EXISTING_ACR" ]; then
            az acr create --name $ACR_NAME --resource-group $RESOURCE_GROUP --sku Basic --admin-enabled true
          else
            echo "ACR $ACR_NAME already exists."
          fi

      - name: Build and Push Docker image to ACR
        run: |
          az acr login --name $ACR_NAME
          FULL_IMAGE="$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG"
          docker build -t $FULL_IMAGE -f app/Dockerfile.streamlit app
          docker push $FULL_IMAGE

      - name: Create or update Container App Environment
        run: |
          EXISTING_ENV=$(az containerapp env show --name $ENV_NAME --resource-group $RESOURCE_GROUP --query "name" -o tsv || echo "")
          if [ -z "$EXISTING_ENV" ]; then
            az containerapp env create \
              --name $ENV_NAME \
              --resource-group $RESOURCE_GROUP \
              --location $LOCATION
          else
            echo "Environment $ENV_NAME already exists."
          fi

      - name: Create App Service Plan and Web App
        run: |
          PLAN_NAME="${{ github.event.inputs.APP_NAME }}-plan"

          # 1. Create App Service Plan (Linux)
          echo "Creating App Service Plan..."
          az appservice plan create --name $PLAN_NAME --resource-group $RESOURCE_GROUP --sku B1 --is-linux

          # 2. Get ACR Credentials (so Web App can pull the image)
          echo "Retrieving ACR Credentials..."
          ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)
          FULL_IMAGE="$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG"

          # 3. Create the Web App
          echo "Creating Web App..."
          az webapp create --resource-group $RESOURCE_GROUP \
            --plan $PLAN_NAME \
            --name $APP_NAME \
            --deployment-container-image-name $FULL_IMAGE \
            --docker-registry-server-url "https://$ACR_NAME.azurecr.io" \
            --docker-registry-server-user $ACR_USERNAME \
            --docker-registry-server-password $ACR_PASSWORD

      - name: Configure Streamlit Port
        run: |
          # Streamlit runs on 8501, but Azure listens on 80/443. 
          # This tells Azure where to route traffic inside the container.
          az webapp config appsettings set --resource-group $RESOURCE_GROUP --name $APP_NAME --settings WEBSITES_PORT=8501
